name: CI Testing

on:
  push:
    branches: [ main, ci-testing ]
  pull_request:
    branches: [ main ]

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Terraform Plan (Dev)
        run: |
          cd terraform
          terraform plan -var-file=environments/dev.tfvars -out=tfplan
        continue-on-error: true

  python-lint-and-test:
    name: Python Linting and Testing
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pylint flake8 black
          pip install -r docker/airflow/requirements.txt
          pip install -r docker/spark/requirements.txt

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 airflow/ spark/ tests/ examples/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 airflow/ spark/ tests/ examples/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: Check code formatting with black
        run: |
          black --check airflow/ spark/ tests/ examples/
        continue-on-error: true

      - name: Lint with pylint
        run: |
          pylint airflow/ spark/ tests/ examples/ --exit-zero
        continue-on-error: true

      - name: Test Airflow DAGs
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/airflow"
          pytest airflow/tests/ -v --tb=short
        continue-on-error: true

      - name: Test Spark transformations
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/spark"
          pytest spark/tests/ -v --tb=short
        continue-on-error: true

      - name: Run integration tests
        run: |
          pytest tests/ -v --tb=short -m "not e2e"
        continue-on-error: true

  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  yaml-lint:
    name: YAML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint Kubernetes manifests
        run: |
          yamllint kubernetes/ -d '{extends: default, rules: {line-length: {max: 120}}}'
        continue-on-error: true

      - name: Lint GitHub workflows
        run: |
          yamllint .github/workflows/ -d '{extends: default, rules: {line-length: {max: 120}}}'
        continue-on-error: true

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [airflow, spark, jupyter]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }} Docker image
        run: |
          if [ "${{ matrix.service }}" = "airflow" ]; then
            docker build -f docker/airflow/Dockerfile -t ldp-airflow:test .
          elif [ "${{ matrix.service }}" = "spark" ]; then
            docker build -f docker/spark/Dockerfile -t ldp-spark:test .
          elif [ "${{ matrix.service }}" = "jupyter" ]; then
            docker build -f docker/jupyter/Dockerfile -t ldp-jupyter:test .
          fi

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README
        run: |
          if [ ! -f README.md ]; then
            echo "README.md not found"
            exit 1
          fi
          echo "README.md exists and is valid"

      - name: Check documentation files
        run: |
          required_docs=("docs/project-structure.md" "docs/setup-guide.md")
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "All required documentation files exist"

      - name: Validate Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

  makefile-test:
    name: Makefile Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Makefile exists
        run: |
          if [ ! -f Makefile ]; then
            echo "Makefile not found"
            exit 1
          fi

      - name: Validate Makefile syntax
        run: |
          make -n help

      - name: List available targets
        run: |
          echo "Available Makefile targets:"
          make help

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  project-structure:
    name: Project Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate project structure
        run: |
          required_dirs=(
            "terraform"
            "kubernetes"
            "airflow/dags"
            "airflow/plugins"
            "spark/jobs"
            "spark/lib"
            "docker"
            "scripts"
            "config"
            "tests"
            "examples"
          )

          missing_dirs=()
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              missing_dirs+=("$dir")
            fi
          done

          if [ ${#missing_dirs[@]} -ne 0 ]; then
            echo "Missing required directories:"
            printf '%s\n' "${missing_dirs[@]}"
            exit 1
          fi

          echo "All required directories exist"

      - name: Check for required files
        run: |
          required_files=(
            "README.md"
            "Makefile"
            ".gitignore"
            "terraform/main.tf"
            "terraform/variables.tf"
            "terraform/outputs.tf"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "Missing required files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi

          echo "All required files exist"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, python-lint-and-test, shellcheck, yaml-lint, docker-build, documentation, makefile-test, security-scan, project-structure]
    if: always()
    steps:
      - name: Check CI Results
        run: |
          echo "CI Pipeline Summary:"
          echo "===================="
          echo "Terraform Validation: ${{ needs.terraform-validate.result }}"
          echo "Python Lint & Test: ${{ needs.python-lint-and-test.result }}"
          echo "ShellCheck: ${{ needs.shellcheck.result }}"
          echo "YAML Lint: ${{ needs.yaml-lint.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"
          echo "Makefile Test: ${{ needs.makefile-test.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Project Structure: ${{ needs.project-structure.result }}"
