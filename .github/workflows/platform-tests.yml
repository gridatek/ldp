---
name: Platform Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  windows-integration-tests:
    name: Windows Integration Tests
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test PowerShell script syntax
        run: |
          Write-Host "Testing PowerShell script syntax..." -ForegroundColor Cyan

          $scripts = @(
            "scripts/windows/setup.ps1",
            "scripts/windows/start.ps1",
            "scripts/windows/stop.ps1",
            "scripts/windows/check-health.ps1"
          )

          foreach ($script in $scripts) {
            Write-Host "Checking $script..." -ForegroundColor Yellow
            $errors = $null
            $null = [System.Management.Automation.PSParser]::Tokenize(
              (Get-Content $script -Raw), [ref]$errors
            )

            if ($errors) {
              Write-Host "Syntax errors found in $script" -ForegroundColor Red
              $errors | ForEach-Object { Write-Host $_ }
              exit 1
            }
            Write-Host "✓ $script is valid" -ForegroundColor Green
          }

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pylint flake8 black

      - name: Lint Python code
        run: |
          flake8 airflow/ spark/ tests/ examples/ `
            --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Test prerequisite checking
        run: |
          Write-Host "Testing prerequisite check functions..." -ForegroundColor Cyan

          # Test command checking logic
          function Test-Command {
            param($Command)
            $null = Get-Command $Command -ErrorAction SilentlyContinue
            return $?
          }

          # These should exist on Windows runner
          $requiredCommands = @("git", "powershell", "python")

          foreach ($cmd in $requiredCommands) {
            if (Test-Command $cmd) {
              Write-Host "✓ $cmd is available" -ForegroundColor Green
            } else {
              Write-Host "✗ $cmd not found" -ForegroundColor Red
              exit 1
            }
          }

      - name: Verify script files exist
        run: |
          $scripts = @(
            "scripts/windows/setup.ps1",
            "scripts/windows/start.ps1",
            "scripts/windows/stop.ps1",
            "scripts/windows/check-health.ps1"
          )

          foreach ($script in $scripts) {
            if (Test-Path $script) {
              Write-Host "✓ $script exists" -ForegroundColor Green
            } else {
              Write-Host "✗ $script missing" -ForegroundColor Red
              exit 1
            }
          }

  macos-integration-tests:
    name: macOS Integration Tests
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test bash script syntax
        run: |
          echo "Testing bash script syntax..."

          scripts=(
            "scripts/setup.sh"
            "scripts/start.sh"
            "scripts/stop.sh"
            "scripts/check-health.sh"
            "scripts/common/detect-platform.sh"
          )

          for script in "${scripts[@]}"; do
            echo "Checking $script..."
            if bash -n "$script"; then
              echo "✓ $script is valid"
            else
              echo "✗ Syntax error in $script"
              exit 1
            fi
          done

      - name: Test platform detection
        run: |
          echo "Testing platform detection..."
          source scripts/common/detect-platform.sh

          PLATFORM=$(detect_platform)
          ARCH=$(detect_arch)

          echo "Detected platform: $PLATFORM"
          echo "Detected architecture: $ARCH"

          if [ "$PLATFORM" = "macos" ]; then
            echo "✓ Platform detection working correctly"
          else
            echo "✗ Expected 'macos', got '$PLATFORM'"
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pylint flake8 black

      - name: Python syntax check
        run: |
          echo "Checking Python syntax..."
          python -m py_compile airflow/dags/**/*.py || true
          python -m py_compile spark/jobs/*.py || true

      - name: Lint Python code
        run: |
          flake8 airflow/ spark/ tests/ examples/ \
            --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Verify script files exist
        run: |
          scripts=(
            "scripts/setup.sh"
            "scripts/start.sh"
            "scripts/stop.sh"
            "scripts/cleanup.sh"
            "scripts/check-health.sh"
            "scripts/common/detect-platform.sh"
          )

          for script in "${scripts[@]}"; do
            if [ -f "$script" ]; then
              echo "✓ $script exists"
            else
              echo "✗ $script missing"
              exit 1
            fi
          done

  linux-integration-tests:
    name: Linux Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test bash script syntax
        run: |
          echo "Testing bash script syntax..."

          scripts=(
            "scripts/setup.sh"
            "scripts/start.sh"
            "scripts/stop.sh"
            "scripts/check-health.sh"
            "scripts/common/detect-platform.sh"
          )

          for script in "${scripts[@]}"; do
            echo "Checking $script..."
            if bash -n "$script"; then
              echo "✓ $script is valid"
            else
              echo "✗ Syntax error in $script"
              exit 1
            fi
          done

      - name: Test platform detection
        run: |
          echo "Testing platform detection..."
          source scripts/common/detect-platform.sh

          PLATFORM=$(detect_platform)
          ARCH=$(detect_arch)

          echo "Detected platform: $PLATFORM"
          echo "Detected architecture: $ARCH"

          if [ "$PLATFORM" = "linux" ]; then
            echo "✓ Platform detection working correctly"
          else
            echo "✗ Expected 'linux', got '$PLATFORM'"
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pylint flake8 black
          pip install -r docker/airflow/requirements.txt || true
          pip install -r docker/spark/requirements.txt || true

      - name: Lint Python code
        run: |
          flake8 airflow/ spark/ tests/ examples/ \
            --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Run Python unit tests
        run: |
          pytest airflow/tests/ -v --tb=short || true
          pytest spark/tests/ -v --tb=short || true
        continue-on-error: true

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x scripts/common/*.sh
          echo "✓ Scripts are executable"

  documentation-validation:
    name: Platform Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify platform guides exist
        run: |
          docs=(
            "docs/platform-guides/macos.md"
            "docs/platform-guides/windows.md"
          )

          for doc in "${docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "✓ $doc exists"
            else
              echo "✗ $doc missing"
              exit 1
            fi
          done

      - name: Check documentation links
        run: |
          echo "Checking for broken internal links..."

          # Check README references platform guides
          if grep -q "platform-guides/macos.md" README.md && \
             grep -q "platform-guides/windows.md" README.md; then
            echo "✓ README.md links to platform guides"
          else
            echo "✗ README.md missing platform guide links"
            exit 1
          fi

      - name: Validate markdown format
        run: |
          echo "Validating markdown files..."

          for file in docs/platform-guides/*.md; do
            if [ -f "$file" ]; then
              # Check for basic markdown structure
              if grep -q "^# " "$file"; then
                echo "✓ $file has proper heading"
              else
                echo "✗ $file missing main heading"
                exit 1
              fi
            fi
          done

  platform-summary:
    name: Platform Test Summary
    runs-on: ubuntu-latest
    needs:
      - windows-integration-tests
      - macos-integration-tests
      - linux-integration-tests
      - documentation-validation
    if: always()
    steps:
      - name: Check Platform Results
        run: |
          echo "Platform Tests Summary:"
          echo "======================"
          echo "Windows Integration: ${{ needs.windows-integration-tests.result }}"
          echo "macOS Integration:   ${{ needs.macos-integration-tests.result }}"
          echo "Linux Integration:   ${{ needs.linux-integration-tests.result }}"
          echo "Documentation:       ${{ needs.documentation-validation.result }}"
          echo ""

          if [ "${{ needs.windows-integration-tests.result }}" = "success" ] && \
             [ "${{ needs.macos-integration-tests.result }}" = "success" ] && \
             [ "${{ needs.linux-integration-tests.result }}" = "success" ] && \
             [ "${{ needs.documentation-validation.result }}" = "success" ]; then
            echo "✅ All platform tests passed!"
            exit 0
          else
            echo "❌ Some platform tests failed"
            exit 1
          fi
