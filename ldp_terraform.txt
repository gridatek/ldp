terraform {
  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.23"
    }
    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.11"
    }
  }
}

provider "kubernetes" {
  config_path    = "~/.kube/config"
  config_context = "minikube"
}

provider "helm" {
  kubernetes {
    config_path    = "~/.kube/config"
    config_context = "minikube"
  }
}

# Create namespace for data platform
resource "kubernetes_namespace" "ldp" {
  metadata {
    name = "ldp"
    labels = {
      name = "local-data-platform"
    }
  }
}

# MinIO - S3-compatible object storage
resource "helm_release" "minio" {
  name       = "minio"
  repository = "https://charts.min.io/"
  chart      = "minio"
  namespace  = kubernetes_namespace.ldp.metadata[0].name
  version    = "5.0.14"

  values = [
    <<-EOT
    replicas: 1
    mode: standalone
    rootUser: admin
    rootPassword: minioadmin
    
    persistence:
      enabled: true
      size: 10Gi
    
    service:
      type: NodePort
      port: 9000
      nodePort: 30900
    
    consoleService:
      type: NodePort
      port: 9001
      nodePort: 30901
    
    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
    
    buckets:
      - name: warehouse
        policy: none
        purge: false
      - name: datalake
        policy: none
        purge: false
    EOT
  ]
}

# PostgreSQL - Metastore for Airflow and Hive
resource "helm_release" "postgresql" {
  name       = "postgresql"
  repository = "https://charts.bitnami.com/bitnami"
  chart      = "postgresql"
  namespace  = kubernetes_namespace.ldp.metadata[0].name
  version    = "13.2.24"

  values = [
    <<-EOT
    auth:
      username: ldp
      password: ldppassword
      database: metastore
    
    primary:
      persistence:
        enabled: true
        size: 8Gi
      
      service:
        type: NodePort
        nodePorts:
          postgresql: 30432
    
    resources:
      requests:
        memory: "256Mi"
        cpu: "250m"
    EOT
  ]
}

# Apache Airflow
resource "helm_release" "airflow" {
  name       = "airflow"
  repository = "https://airflow.apache.org"
  chart      = "airflow"
  namespace  = kubernetes_namespace.ldp.metadata[0].name
  version    = "1.11.0"

  depends_on = [
    helm_release.postgresql
  ]

  values = [
    <<-EOT
    executor: "KubernetesExecutor"
    
    airflowVersion: "2.7.3"
    
    defaultAirflowRepository: apache/airflow
    defaultAirflowTag: "2.7.3"
    
    webserver:
      service:
        type: NodePort
        ports:
          - name: airflow-ui
            port: 8080
            nodePort: 30080
      
      defaultUser:
        enabled: true
        username: admin
        password: admin
        email: admin@ldp.local
        firstName: Admin
        lastName: User
        role: Admin
    
    postgresql:
      enabled: false
    
    data:
      metadataConnection:
        user: ldp
        pass: ldppassword
        protocol: postgresql
        host: postgresql
        port: 5432
        db: metastore
    
    dags:
      persistence:
        enabled: true
        size: 1Gi
    
    logs:
      persistence:
        enabled: true
        size: 5Gi
    
    env:
      - name: AIRFLOW__CORE__LOAD_EXAMPLES
        value: "False"
      - name: AIRFLOW__WEBSERVER__EXPOSE_CONFIG
        value: "True"
    EOT
  ]

  timeout = 600
}

# Apache Spark
resource "helm_release" "spark" {
  name       = "spark"
  repository = "https://charts.bitnami.com/bitnami"
  chart      = "spark"
  namespace  = kubernetes_namespace.ldp.metadata[0].name
  version    = "8.1.5"

  values = [
    <<-EOT
    master:
      service:
        type: NodePort
        nodePorts:
          http: 30707
          cluster: 30077
      
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
    
    worker:
      replicaCount: 2
      
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
      
      extraEnvVars:
        - name: SPARK_WORKER_MEMORY
          value: "1G"
        - name: SPARK_WORKER_CORES
          value: "1"
    
    image:
      registry: docker.io
      repository: bitnami/spark
      tag: 3.5.0
    EOT
  ]
}

# Jupyter Notebook for Spark development
resource "kubernetes_deployment" "jupyter" {
  depends_on = [helm_release.spark, helm_release.minio]

  metadata {
    name      = "jupyter"
    namespace = kubernetes_namespace.ldp.metadata[0].name
  }

  spec {
    replicas = 1

    selector {
      match_labels = {
        app = "jupyter"
      }
    }

    template {
      metadata {
        labels = {
          app = "jupyter"
        }
      }

      spec {
        container {
          name  = "jupyter"
          image = "jupyter/pyspark-notebook:latest"

          port {
            container_port = 8888
          }

          env {
            name  = "JUPYTER_ENABLE_LAB"
            value = "yes"
          }

          env {
            name  = "SPARK_MASTER"
            value = "spark://spark-master-svc:7077"
          }

          resources {
            requests = {
              memory = "1Gi"
              cpu    = "500m"
            }
          }
        }
      }
    }
  }
}

resource "kubernetes_service" "jupyter" {
  metadata {
    name      = "jupyter"
    namespace = kubernetes_namespace.ldp.metadata[0].name
  }

  spec {
    type = "NodePort"

    selector = {
      app = "jupyter"
    }

    port {
      port        = 8888
      target_port = 8888
      node_port   = 30888
    }
  }
}

# Output important information
output "platform_info" {
  value = {
    namespace = kubernetes_namespace.ldp.metadata[0].name
    services = {
      airflow = {
        url      = "http://$(minikube ip):30080"
        username = "admin"
        password = "admin"
      }
      minio = {
        console_url = "http://$(minikube ip):30901"
        api_url     = "http://$(minikube ip):30900"
        username    = "admin"
        password    = "minioadmin"
      }
      spark = {
        master_url = "http://$(minikube ip):30707"
      }
      jupyter = {
        url = "http://$(minikube ip):30888"
      }
      postgresql = {
        host     = "postgresql"
        port     = 5432
        database = "metastore"
        username = "ldp"
        password = "ldppassword"
      }
    }
  }
}
